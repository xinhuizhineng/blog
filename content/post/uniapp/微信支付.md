---
title: "微信支付接入指南：JSAPI、H5与小程序"
author: "常香玉"
description: "详解微信支付的三种核心场景：公众号支付(JSAPI)、H5支付及小程序支付的开发流程与关键配置。"
date: 2023-03-12T13:05:18+08:00
lastmod: 2023-03-12
tags:
  - "Web前端"
  - "uniapp"
  - "微信支付"
categories:
  - "Web前端"
  - "支付集成"
---

本文总结了前端开发中常见的微信支付三种接入场景及其核心流程。

## 1. 公众号支付 (JSAPI)

**适用场景**：微信内置浏览器、微信客户端扫码、企业微信网页。

### 核心流程
1.  **网页授权获取 Code**：
    引导用户访问微信授权链接，获取 `code`。
    ```http
    https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=snsapi_base&state=123#wechat_redirect
    ```
2.  **获取 OpenID**：
    后端使用 `appid`、`secret` 和前端传来的 `code` 换取用户的 `openid`。
3.  **统一下单**：
    后端调用微信统一下单接口，获取支付参数（`timeStamp`, `nonceStr`, `package`, `signType`, `paySign`）。
4.  **唤起支付**：
    前端使用 `WeixinJSBridge.invoke` 或 `wx.chooseWXPay` 调起支付窗口。

### ⚠️ 注意事项
*   **授权域名**：`redirect_uri` 的域名必须在**微信公众平台**的“网页授权域名”中配置。
*   **支付目录**：支付页面的路径必须在**微信商户平台**配置“JSAPI支付授权目录”。
*   **AppID**：此处使用**公众号**的 AppID。

---

## 2. H5 支付

**适用场景**：外部移动端浏览器（如 Safari, Chrome）、App 内嵌 H5（非微信环境）。

### 核心流程
1.  **后端下单**：
    后端调用微信统一下单接口（交易类型为 `MWEB`）。
2.  **获取跳转链接**：
    接口返回 `mweb_url`（即原文中的 `pay_url`）。
3.  **跳转支付**：
    前端直接跳转该链接，微信会中间页唤起微信客户端进行支付。
    ```javascript
    // 示例：跳转并指定支付后的回调页
    window.location.href = mweb_url + '&redirect_url=' + encodeURIComponent(window.location.href);
    ```

### ⚠️ 注意事项
*   **Referer 校验**：微信会校验发起支付请求的域名（Referer），需在商户平台配置“H5支付域名”。
*   **AppID**：此处使用**商户绑定的移动应用或公众号** AppID。

---

## 3. 小程序支付

**适用场景**：微信小程序原生环境。

### 核心流程
1.  **获取登录凭证**：
    前端调用 `wx.login()` 获取 `code`。
2.  **获取 OpenID**：
    后端通过 `appid`、`secret` 和 `code` 换取 `openid`。
3.  **后端下单**：
    后端调用统一下单接口，返回支付核心参数（`paySign` 等）。
4.  **唤起支付**：
    前端调用小程序 API 进行支付：
    ```javascript
    wx.requestPayment({
      timeStamp: '',
      nonceStr: '',
      package: '',
      signType: 'MD5',
      paySign: '',
      success (res) { },
      fail (res) { }
    })
    ```

### ⚠️ 注意事项
*   **AppID**：此处必须使用**小程序**的 AppID。
*   **账号关联**：小程序必须已关联到微信商户号。
