---
title: "导航流程"
author: "常香玉"
description : "导航流程"
date: 2023-01-30T13:05:18+08:00
lastmod: 2023-01-30
tags : [
    "浏览器工作原理与实践",
    "导航流程"
]
categories : [
    "浏览器工作原理与实践",
]
---

## 从输入 URL 到页面展示，这中间发生了什么？

- 从输入 URL 到页面展示完整流程示意图：

![从输入 URL 到页面展示完整流程示意图](images/browser-principles-and-practice/browser.jpg)

- **浏览器进程**：主要负责用户交互、子进程管理和文件储存等功能。
- **网络进程**：面向渲染进程和浏览器进程等提供网络下载功能。
- **渲染进程**：主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。
    - 因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。
    - 这也是为什么 Chrome 会让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

**简要流程：**

1. 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给网络进程。
2. 然后，在网络进程中发起真正的 URL 请求。
3. 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给浏览器进程。
4. 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程。
5. 渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道。
6. 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解析页面数据了”。
7. 浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。

用户发出 URL 请求到页面开始解析的这个过程，就叫做 **导航**。

---

# 详细阶段解析

### 1. 用户输入

当用户在地址栏中输入一个查询关键字时，地址栏会判断输入的关键字是 **搜索内容**，还是 **请求的 URL**。

- 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
- 如果判断输入内容符合 URL 规则，比如输入的是 `time.geekbang.org`，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL，如 `https://time.geekbang.org`。

当用户输入关键字并键入回车之后，这意味着当前页面即将要被替换成新的页面。不过在这个流程继续之前，浏览器还给了当前页面一次执行 `beforeunload` 事件的机会。

> `beforeunload` 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面，比如当前页面可能有未提交完成的表单等情况，因此用户可以通过 `beforeunload` 事件来取消导航，让浏览器不再执行任何后续工作。

当浏览器刚开始加载一个地址之后，标签页上的图标便进入了加载状态。但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为极客时间的页面。因为需要等待提交文档阶段，页面内容才会被替换。

### 2. URL 请求过程

浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。

1. 首先，网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。
2. 这请求前的第一步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么还需要建立 TLS 连接。
3. 接下来就是利用 IP 地址和服务器建立 TCP 连接。连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息。
4. 服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了。

在导航过程中，如果服务器响应行的状态码包含了 301、302 一类的跳转信息，浏览器会跳转到新的地址继续导航；如果响应行是 200，那么表示浏览器可以继续处理该请求。

#### （1）重定向

在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码是 301 或者 302，那么说明服务器需要浏览器重定向到其他 URL。这时网络进程会从响应头的 `Location` 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求，一切又重头开始了。

使用 `curl -I + URL` 的命令可以接收服务器返回的响应头的信息。

![响应头的信息示意图](images/browser-principles-and-practice/2.jpg)

HTTP 向极客时间服务器请求时，服务器会返回一个包含有 301 或者 302 状态码响应头，并把响应头的 `Location` 字段中填上 HTTPS 的地址，这就是告诉了浏览器要重新导航到新的地址上。

#### （2）响应数据类型处理

`Content-Type` 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型。

**案例 A：HTML 类型**
执行命令：`curl -I https://time.geekbang.org/`

![响应数据类型处理示意图](images/browser-principles-and-practice/3.jpg)

响应头中的 `Content-type` 字段的值是 `text/html`，这就是告诉浏览器，服务器返回的数据是 **HTML 格式**。

**案例 B：下载类型**
执行命令：`curl -I https://res001.geekbang.org/.../geektime.apk`

![响应数据类型处理示意图](images/browser-principles-and-practice/4.jpg)

从返回的响应头信息来看，其 `Content-Type` 的值是 `application/octet-stream`，显示数据是 **字节流类型** 的，通常情况下，浏览器会按照 **下载类型** 来处理该请求。

如果 `Content-Type` 字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束。但如果是 HTML，那么浏览器则会继续进行导航流程。

### 3. 准备渲染进程

那什么情况下多个页面会同时运行在一个渲染进程中呢？

**同一站点（same-site）**：定义为 **根域名**（例如，`geekbang.org`）加上 **协议**（例如，`https://` 或者 `http://`），还包含了该根域名下的所有子域名和不同的端口。

Chrome 的默认策略是，每个标签对应一个渲染进程。但 **如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程**。官方把这个默认策略叫 `process-per-site-instance`。

总结来说，打开一个新页面采用的 **渲染进程策略** 就是：
- 通常情况下，打开新的页面都会使用单独的渲染进程；
- 如果从 A 页面打开 B 页面，且 A 和 B 都属于 **同一站点** 的话，那么 B 页面复用 A 页面的渲染进程；
- 如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程。

### 4. 提交文档

所谓提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程。

1. 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
2. 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
3. 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
4. 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

到这里，一个完整的导航流程就“走”完了，这之后就要进入渲染阶段了。

### 5. 渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载了。一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。  

### 总结
服务器可以根据响应头来控制浏览器的行为，如跳转、网络数据类型判断。  

Chrome 默认采用每个标签对应一个渲染进程，但是如果两个页面属于同一站点，那这两个标签会使用同一个渲染进程。  

浏览器的导航过程涵盖了从用户发起请求到提交文档给渲染进程的中间所有阶段。

1. 浏览器进程（Browser Process）主导：
- 处理输入：区分是搜索关键字还是 URL。
- 生命周期管理：触发 beforeunload 事件（允许页面清理或取消导航）。
- 状态更新：加载动画开始，但页面内容需等待“提交文档”后才替换。
2.网络进程（Network Process）执行：
- 资源查找：先查本地缓存，无缓存则发起网络请求。
- 建立连接：DNS 解析 -> 建立 TCP 连接 -> 构建请求头/Cookie。
- 处理响应：
    - 重定向：若遇 301/302，读取 Location 重新发起请求。
    - 类型判断：通过 Content-Type 判断是下载（application/octet-stream）还是 HTML 导航（text/html）。
3.准备渲染进程（Render Process）：
- 默认策略：通常每个标签页一个进程。
- 同一站点（Same-site）策略：如果新页面与旧页面属于同一站点（根域名+协议相同），则复用父页面的渲染进程（process-per-site-instance）。
4. 提交文档（Commit Navigation）：
- 这是导航流程的终点。浏览器进程通知渲染进程，渲染进程与网络进程建立数据管道接收 HTML。
- 一旦确认提交，旧文档被移除，界面 UI（地址栏、后退按钮等）正式更新。
