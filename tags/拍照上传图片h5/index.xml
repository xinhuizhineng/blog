<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>拍照上传图片h5 on 我的空间</title><link>https://changxiangyu.cn/tags/%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/</link><description>Recent content in 拍照上传图片h5 on 我的空间</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 30 Dec 2022 13:05:18 +0800</lastBuildDate><atom:link href="https://changxiangyu.cn/tags/%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/index.xml" rel="self" type="application/rss+xml"/><item><title>uniapp拍照上传图片h5</title><link>https://changxiangyu.cn/p/uniapp%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/</link><pubDate>Fri, 30 Dec 2022 13:05:18 +0800</pubDate><guid>https://changxiangyu.cn/p/uniapp%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/</guid><description>&lt;h1 id="step-1-界面代码实现">Step 1: 界面代码实现&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;template&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;body&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;btn&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;picture-img&amp;#34; ref=&amp;#34;uploadContent&amp;#34; id=&amp;#34;uploadContent&amp;#34; @click=&amp;#34;takePhotos()&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;div class=&amp;#34;loader-19&amp;#34; v-if=&amp;#34;loader&amp;#34;&amp;gt;&amp;lt;/div&amp;gt;点击修改
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/template&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="step-2-使用到的方法">Step 2: 使用到的方法&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;span class="lnt">96
&lt;/span>&lt;span class="lnt">97
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">takePhotos() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const _that = this;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (document.getElementById(&amp;#34;take-picture&amp;#34;) == null) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let input = _that.createInputAndSetAttribute();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$refs.uploadContent.$el.appendChild(input);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.onchange = async (event) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.loader = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var files = event.target.files
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (files &amp;amp;&amp;amp; files.length &amp;gt; 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const file = files[0];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 压缩图片需要的一些元素和对象
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var reader = new FileReader(),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img = new Image();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 缩放图片需要的canvas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var canvas = document.createElement(&amp;#39;canvas&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var context = canvas.getContext(&amp;#39;2d&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // base64地址图片加载完毕后
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onload = function() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var originWidth = this.width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var originHeight = this.height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 最大尺寸限制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var maxWidth = 960,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maxHeight = 1280;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 目标尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var targetWidth = originWidth,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = originHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片尺寸超过400x400的限制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth &amp;gt; maxWidth || originHeight &amp;gt; maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth / originHeight &amp;gt; maxWidth / maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 更宽，按照宽度限定尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = maxWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = Math.round(maxWidth * (originHeight / originWidth));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = maxHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = Math.round(maxHeight * (originWidth / originHeight));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // canvas对图片进行缩放
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = targetWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = targetHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 清除画布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.clearRect(0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片压缩
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.drawImage(img, 0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // canvas转为blob并上传
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.toBlob(async (blob) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const newFile = new File([blob], &amp;#39;123.jpg&amp;#39;, {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: blob.type
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const imgPath = await upload(newFile, file.path, `/qy/photo`)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const detectionRes = await detection(imgPath)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await editFacePhoto(detectionRes).then(res =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (res.code === 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.photoSrc = res.imgUrl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$u.toast(&amp;#34;上传成功！&amp;#34;, 2000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$u.toast(res.msg, 3000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.loader = false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.removeDocument()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }, file.type || &amp;#39;image/png&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 文件base64化，以便获知图片原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onload = function(e) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.src = e.target.result;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.readAsDataURL(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> document.querySelector(&amp;#34;#take-picture&amp;#34;).click();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// 创建input并设置input的属性
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">createInputAndSetAttribute() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var input = document.createElement(&amp;#39;input&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.type = &amp;#39;file&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.id = &amp;#39;take-picture&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.accept = &amp;#39;image/*&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // input.capture = &amp;#39;user&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.opacity = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.position = &amp;#39;absolute&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.top = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.left = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.width = &amp;#39;50px&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.height = &amp;#39;50px&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return input;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// 移除input节点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">removeDocument() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const uploadContent = document.getElementById(&amp;#34;uploadContent&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const takePicture = document.getElementById(&amp;#34;take-picture&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uploadContent.removeChild(takePicture);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可参考： &lt;a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file" target="_blank" rel="noopener"
>https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file&lt;/a>&lt;/p>
&lt;h2 id="目前的实现方式有几个优化点">目前的实现方式有几个优化点：&lt;/h2>
&lt;ol>
&lt;li>Vue 违规操作：在 Vue/Uniapp 中频繁使用 document.createElement、appendChild 和 removeChild 是不推荐的（这是 jQuery 时代的思维），应该利用 Vue 的模板语法。&lt;/li>
&lt;li>回调地狱：FileReader、Image.onload、canvas.toBlob 层层嵌套，代码难以维护。&lt;/li>
&lt;li>逻辑耦合：压缩逻辑、上传逻辑和 UI 交互混在一起。
以下是优化后的版本，采用 Vue 数据驱动 的方式，并将压缩逻辑封装为 Promise，使代码清晰易读。&lt;/li>
&lt;/ol>
&lt;h2 id="优化思路">优化思路&lt;/h2>
&lt;ol>
&lt;li>&lt;strong>移除 DOM 操作&lt;/strong>：将 &lt;code>&amp;lt;input type=&amp;quot;file&amp;quot;&amp;gt;&lt;/code> 直接写在 &lt;code>&amp;lt;template&amp;gt;&lt;/code> 中并通过 &lt;code>v-show&lt;/code> 隐藏，通过 &lt;code>ref&lt;/code> 触发点击，避免动态创建销毁 DOM。&lt;/li>
&lt;li>&lt;strong>异步扁平化&lt;/strong>：将图片加载和 Canvas 压缩逻辑封装成 &lt;code>Promise&lt;/code>，使用 &lt;code>async/await&lt;/code> 替代回调函数。&lt;/li>
&lt;li>&lt;strong>功能拆分&lt;/strong>：将“选择图片”、“压缩图片”、“上传业务”拆分为独立方法。&lt;/li>
&lt;/ol>
&lt;h2 id="step-1-界面代码实现-1">Step 1: 界面代码实现&lt;/h2>
&lt;p>使用 &lt;code>ref&lt;/code> 引用隐藏的 input 元素，保持页面结构整洁。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;body&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;btn&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- 触发按钮 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;picture-img&amp;#34;&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="na">click&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;triggerSelect&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;loader-19&amp;#34;&lt;/span> &lt;span class="na">v-if&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;loader&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {{ loader ? &amp;#39;处理中...&amp;#39; : &amp;#39;点击修改&amp;#39; }}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- 隐藏的原生Input，用于H5调用相机/文件 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- accept=&amp;#34;image/*&amp;#34; 限制图片，capture=&amp;#34;user&amp;#34; 可选：强制调用前置摄像头 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">input&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">ref&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;fileInput&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">accept&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;image/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;hidden-input&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">@&lt;/span>&lt;span class="na">change&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;handleFileChange&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">style&lt;/span> &lt;span class="na">scoped&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="nc">hidden-input&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">display&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">none&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c">/* 隐藏input */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* 你的其他样式... */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">style&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="step-2-逻辑实现-script">Step 2: 逻辑实现 (Script)&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">export default {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> loader: false,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> photoSrc: &amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> methods: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 1. 触发文件选择
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> triggerSelect() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 在Uniapp H5中，通过$refs获取原生DOM元素并点击
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 注意：App端不支持此操作，App端请使用 uni.chooseImage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$refs.fileInput.click();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 2. 监听文件改变
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> async handleFileChange(event) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const files = event.target.files;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (!files || files.length === 0) return;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.loader = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const file = files[0];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> try {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // A. 压缩图片
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const { blob, filename } = await this.compressImage(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // B. 构造新的File对象 (解决部分浏览器兼容性)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const newFile = new File([blob], filename || &amp;#39;compressed.jpg&amp;#39;, { type: blob.type });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // C. 执行上传业务
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await this.uploadProcess(newFile, file.path); // file.path 在H5 input中可能不存在，视业务需求调整
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } catch (error) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.error(&amp;#34;处理失败&amp;#34;, error);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(&amp;#34;图片处理失败&amp;#34;, 2000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } finally {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.loader = false;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 清空value，确保下次选择同一张图也能触发change事件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> event.target.value = &amp;#39;&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 3. 核心：图片压缩工具函数 (返回Promise)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> compressImage(file) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return new Promise((resolve, reject) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const reader = new FileReader();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.readAsDataURL(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onload = (e) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const img = new Image();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.src = e.target.result;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onload = () =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const originWidth = img.width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const originHeight = img.height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 目标尺寸配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const maxWidth = 960;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const maxHeight = 1280;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let targetWidth = originWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let targetHeight = originHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 计算缩放比例
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth &amp;gt; maxWidth || originHeight &amp;gt; maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth / originHeight &amp;gt; maxWidth / maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = maxWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = Math.round(maxWidth * (originHeight / originWidth));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = maxHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = Math.round(maxHeight * (originWidth / originHeight));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // Canvas 绘制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const canvas = document.createElement(&amp;#39;canvas&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const context = canvas.getContext(&amp;#39;2d&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = targetWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = targetHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.clearRect(0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.drawImage(img, 0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 导出 Blob
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.toBlob((blob) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (blob) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resolve({ blob, filename: file.name });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reject(new Error(&amp;#39;Canvas to Blob failed&amp;#39;));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }, file.type || &amp;#39;image/jpeg&amp;#39;, 0.8); // 0.8 为压缩质量
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onerror = (err) =&amp;gt; reject(err);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onerror = (err) =&amp;gt; reject(err);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 4. 上传业务逻辑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> async uploadProcess(file, originalPath) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 假设 upload, detection, editFacePhoto 已导入或定义
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const imgPath = await upload(file, originalPath, `/qy/photo`);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const detectionRes = await detection(imgPath);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const res = await editFacePhoto(detectionRes);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (res.code === 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.photoSrc = res.imgUrl;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(&amp;#34;上传成功！&amp;#34;, 2000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(res.msg, 3000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="关键改进点说明">关键改进点说明&lt;/h3>
&lt;ol>
&lt;li>Input 复用：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>原代码每次点击都 &lt;code>createElement&lt;/code>，不仅性能低，而且在部分安卓 WebView 中可能因为 DOM 未完全插入而无法唤起相机。&lt;/li>
&lt;li>新代码将&lt;code> &amp;lt;input&amp;gt;&lt;/code> 静态化，利用 &lt;code>event.target.value = ''&lt;/code> 重置状态，确保稳定性。&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>Promise 封装：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>原代码在 &lt;code>img.onload&lt;/code> 内部嵌套了大量业务逻辑。&lt;/li>
&lt;li>新代码将压缩逻辑提取为 &lt;code>compressImage&lt;/code>，返回 Promise，使得主流程 &lt;code>handleFileChange&lt;/code> 可以使用 &lt;code>await&lt;/code> 顺序执行，逻辑一目了然。&lt;/li>
&lt;/ul>
&lt;ol start="3">
&lt;li>兼容性处理：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>增加了 &lt;code>canvas.toBlob&lt;/code> 的质量参数（0.8），可进一步减小体积。&lt;/li>
&lt;li>增加了 &lt;code>input&lt;/code> 的 &lt;code>display: none&lt;/code> 样式，避免页面出现奇怪的占位。&lt;/li>
&lt;/ul></description></item></channel></rss>