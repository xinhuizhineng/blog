<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>uniapp on 我的空间</title><link>https://changxiangyu.cn/tags/uniapp/</link><description>Recent content in uniapp on 我的空间</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 12 Mar 2023 13:05:18 +0800</lastBuildDate><atom:link href="https://changxiangyu.cn/tags/uniapp/index.xml" rel="self" type="application/rss+xml"/><item><title>微信支付接入指南：JSAPI、H5与小程序</title><link>https://changxiangyu.cn/p/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97jsapih5%E4%B8%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F/</link><pubDate>Sun, 12 Mar 2023 13:05:18 +0800</pubDate><guid>https://changxiangyu.cn/p/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97jsapih5%E4%B8%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F/</guid><description>&lt;p>本文总结了前端开发中常见的微信支付三种接入场景及其核心流程。&lt;/p>
&lt;h2 id="1-公众号支付-jsapi">1. 公众号支付 (JSAPI)&lt;/h2>
&lt;p>&lt;strong>适用场景&lt;/strong>：微信内置浏览器、微信客户端扫码、企业微信网页。&lt;/p>
&lt;h3 id="核心流程">核心流程&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>网页授权获取 Code&lt;/strong>：
引导用户访问微信授权链接，获取 &lt;code>code&lt;/code>。
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="line">&lt;span class="cl">&lt;span class="err">https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;amp;redirect_uri=REDIRECT_URI&amp;amp;response_type=code&amp;amp;scope=snsapi_base&amp;amp;state=123#wechat_redirect
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;strong>获取 OpenID&lt;/strong>：
后端使用 &lt;code>appid&lt;/code>、&lt;code>secret&lt;/code> 和前端传来的 &lt;code>code&lt;/code> 换取用户的 &lt;code>openid&lt;/code>。&lt;/li>
&lt;li>&lt;strong>统一下单&lt;/strong>：
后端调用微信统一下单接口，获取支付参数（&lt;code>timeStamp&lt;/code>, &lt;code>nonceStr&lt;/code>, &lt;code>package&lt;/code>, &lt;code>signType&lt;/code>, &lt;code>paySign&lt;/code>）。&lt;/li>
&lt;li>&lt;strong>唤起支付&lt;/strong>：
前端使用 &lt;code>WeixinJSBridge.invoke&lt;/code> 或 &lt;code>wx.chooseWXPay&lt;/code> 调起支付窗口。&lt;/li>
&lt;/ol>
&lt;h3 id="-注意事项">⚠️ 注意事项&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>授权域名&lt;/strong>：&lt;code>redirect_uri&lt;/code> 的域名必须在&lt;strong>微信公众平台&lt;/strong>的“网页授权域名”中配置。&lt;/li>
&lt;li>&lt;strong>支付目录&lt;/strong>：支付页面的路径必须在&lt;strong>微信商户平台&lt;/strong>配置“JSAPI支付授权目录”。&lt;/li>
&lt;li>&lt;strong>AppID&lt;/strong>：此处使用&lt;strong>公众号&lt;/strong>的 AppID。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="2-h5-支付">2. H5 支付&lt;/h2>
&lt;p>&lt;strong>适用场景&lt;/strong>：外部移动端浏览器（如 Safari, Chrome）、App 内嵌 H5（非微信环境）。&lt;/p>
&lt;h3 id="核心流程-1">核心流程&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>后端下单&lt;/strong>：
后端调用微信统一下单接口（交易类型为 &lt;code>MWEB&lt;/code>）。&lt;/li>
&lt;li>&lt;strong>获取跳转链接&lt;/strong>：
接口返回 &lt;code>mweb_url&lt;/code>（即原文中的 &lt;code>pay_url&lt;/code>）。&lt;/li>
&lt;li>&lt;strong>跳转支付&lt;/strong>：
前端直接跳转该链接，微信会中间页唤起微信客户端进行支付。
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 示例：跳转并指定支付后的回调页
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">href&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mweb_url&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;redirect_url=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">encodeURIComponent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">href&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="-注意事项-1">⚠️ 注意事项&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Referer 校验&lt;/strong>：微信会校验发起支付请求的域名（Referer），需在商户平台配置“H5支付域名”。&lt;/li>
&lt;li>&lt;strong>AppID&lt;/strong>：此处使用&lt;strong>商户绑定的移动应用或公众号&lt;/strong> AppID。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="3-小程序支付">3. 小程序支付&lt;/h2>
&lt;p>&lt;strong>适用场景&lt;/strong>：微信小程序原生环境。&lt;/p>
&lt;h3 id="核心流程-2">核心流程&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>获取登录凭证&lt;/strong>：
前端调用 &lt;code>wx.login()&lt;/code> 获取 &lt;code>code&lt;/code>。&lt;/li>
&lt;li>&lt;strong>获取 OpenID&lt;/strong>：
后端通过 &lt;code>appid&lt;/code>、&lt;code>secret&lt;/code> 和 &lt;code>code&lt;/code> 换取 &lt;code>openid&lt;/code>。&lt;/li>
&lt;li>&lt;strong>后端下单&lt;/strong>：
后端调用统一下单接口，返回支付核心参数（&lt;code>paySign&lt;/code> 等）。&lt;/li>
&lt;li>&lt;strong>唤起支付&lt;/strong>：
前端调用小程序 API 进行支付：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">wx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">requestPayment&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">timeStamp&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">nonceStr&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">package&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">signType&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;MD5&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">paySign&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">success&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fail&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="-注意事项-2">⚠️ 注意事项&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>AppID&lt;/strong>：此处必须使用&lt;strong>小程序&lt;/strong>的 AppID。&lt;/li>
&lt;li>&lt;strong>账号关联&lt;/strong>：小程序必须已关联到微信商户号。&lt;/li>
&lt;/ul>
&lt;h2 id="4-附录前端环境判断工具">4. 附录：前端环境判断工具&lt;/h2>
&lt;p>在发起支付前，我们需要根据当前运行环境（User Agent）来决定调用 JSAPI 支付还是 H5 支付。可以使用以下工具函数进行判断：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/**
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 获取当前运行平台
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * @returns {string} &amp;#39;wecom&amp;#39; | &amp;#39;wechat&amp;#39; | &amp;#39;h5&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> */
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">function getPlat() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const ua = window.navigator.userAgent.toLowerCase();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (ua.includes(&amp;#39;wxwork&amp;#39;)) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return &amp;#39;wecom&amp;#39;; // 企业微信环境（需使用企业微信JS-SDK或兼容JSAPI）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else if (ua.includes(&amp;#39;micromessenger&amp;#39;)) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return &amp;#39;wechat&amp;#39;; // 微信内置浏览器（使用 JSAPI 支付）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return &amp;#39;h5&amp;#39;; // 普通浏览器（使用 H5 支付）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// 业务逻辑调用示例
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">const platform = getPlat();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">if (platform === &amp;#39;wechat&amp;#39; || platform === &amp;#39;wecom&amp;#39;) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 执行 JSAPI 支付逻辑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.log(&amp;#34;检测到微信环境，准备唤起 JSAPI 支付&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // doJSAPIPay();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">} else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 执行 H5 支付逻辑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.log(&amp;#34;检测到外部浏览器，准备唤起 H5 支付&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // doH5Pay();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="补充说明">补充说明&lt;/h3>
&lt;ul>
&lt;li>企业微信兼容性：在企业微信（wxwork）中，通常也兼容微信的 JSAPI 支付，但建议参考企业微信官方文档确认是否需要引入特定的 jweixin-module。&lt;/li>
&lt;li>小程序环境判断：如果您还需要判断是否在小程序 Webview 中，可以增加一个判断条件：&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">if (ua.includes(&amp;#39;miniprogram&amp;#39;) || window.__wxjs_environment === &amp;#39;miniprogram&amp;#39;) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return &amp;#39;miniprogram&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>uniapp-h5自定义配置文件</title><link>https://changxiangyu.cn/p/uniapp-h5%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</link><pubDate>Wed, 25 Jan 2023 13:05:18 +0800</pubDate><guid>https://changxiangyu.cn/p/uniapp-h5%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</guid><description>&lt;p>uniapp项目H5发行（发行-&amp;gt;网站-PC web或手机H5）打包后&lt;br>
如果要给项目封装一个请求，但请求地址必须读取配置文件，从配置文件中拿地址，后续随时更改配置文件，直接让请求地址发生变化。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>核心思路：利用打包后的&lt;code>index.html&lt;/code>文件，原生&lt;code>&amp;lt;script&amp;gt;&lt;/code>引入配置文件，在全局可调用。
uniapp 官方解决方案（建议看一眼）：&lt;a class="link" href="https://uniapp.dcloud.io/collocation/manifest.html#h5=template" target="_blank" rel="noopener"
>&lt;/a>&lt;/p>
&lt;ol>
&lt;li>建立一个&lt;code>config.js&lt;/code>配置文件：
&lt;code>var config = { defaultUrl: &amp;quot;https://c3test.dassoft.cn&amp;quot;, tenantCode: &amp;quot;admin&amp;quot; }&lt;/code>&lt;br>
保存到桌面上即可，无需放到项目中。&lt;/li>
&lt;li>在项目根目录新建&lt;code>temp.h5.html&lt;/code>空文件，cli创建的话同理&lt;/li>
&lt;li>打开&lt;code>temp.h5.html&lt;/code>复制以下模板代码，&lt;code>&amp;lt;script&amp;gt;&lt;/code>引入配置文件：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> &amp;lt;html lang=&amp;#34;zh-CN&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;meta charset=&amp;#34;utf-8&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;meta http-equiv=&amp;#34;X-UA-Compatible&amp;#34; content=&amp;#34;IE=edge&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;title&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;%= htmlWebpackPlugin.options.title %&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/title&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- Open Graph data --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- &amp;lt;meta property=&amp;#34;og:title&amp;#34; content=&amp;#34;Title Here&amp;#34; /&amp;gt; --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- &amp;lt;meta property=&amp;#34;og:url&amp;#34; content=&amp;#34;http://www.example.com/&amp;#34; /&amp;gt; --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- &amp;lt;meta property=&amp;#34;og:image&amp;#34; content=&amp;#34;http://example.com/image.jpg&amp;#34; /&amp;gt; --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- &amp;lt;meta property=&amp;#34;og:description&amp;#34; content=&amp;#34;Description Here&amp;#34; /&amp;gt; --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;script&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var coverSupport = &amp;#39;CSS&amp;#39; in window &amp;amp;&amp;amp; typeof CSS.supports === &amp;#39;function&amp;#39; &amp;amp;&amp;amp; (CSS.supports(&amp;#39;top: env(a)&amp;#39;) || CSS.supports(&amp;#39;top: constant(a)&amp;#39;))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> document.write(&amp;#39;&amp;lt;meta name=&amp;#34;viewport&amp;#34; content=&amp;#34;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&amp;#39; + (coverSupport ? &amp;#39;, viewport-fit=cover&amp;#39; : &amp;#39;&amp;#39;) + &amp;#39;&amp;#34; /&amp;gt;&amp;#39;)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/script&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;link rel=&amp;#34;stylesheet&amp;#34; href=&amp;#34;&amp;lt;%= BASE_URL %&amp;gt;static/index.&amp;lt;%= VUE_APP_INDEX_CSS_HASH %&amp;gt;.css&amp;#34; /&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;noscript&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;strong&amp;gt;Please enable JavaScript to continue.&amp;lt;/strong&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/noscript&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;div id=&amp;#34;app&amp;#34;&amp;gt;&amp;lt;/div&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;!-- built files will be auto injected --&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;script language=&amp;#34;javascript&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //使用了 sessionStorage和时间戳，这样可以防止 js和css的缓存,页面会话刷新时间为半小时
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var timestamp = new Date().getTime();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var versionStamp = sessionStorage.version;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (versionStamp == null || (timestamp - versionStamp) &amp;gt; 1800000) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sessionStorage.version = timestamp;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> document.write(&amp;#39;&amp;lt;script src=&amp;#34;./config.js?v=&amp;#39; + sessionStorage.version + &amp;#39;&amp;#34;&amp;gt;&amp;lt;\/script\&amp;gt;&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/script&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/html&amp;gt;```
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>提前写好获取配置文件的代码（在哪里用配置文件就在那里写）&lt;br>
&lt;code>export const defaultUrl = config.defaultUrl;&lt;/code>&lt;br>
开发中，可以先写死参数，后续要打包后在变更。&lt;/li>
&lt;li>打开&lt;code>manifest.json&lt;/code>文件，将&lt;code>temp.h5.html&lt;/code>关联：
&lt;img src="https://changxiangyu.cn/images/uniapp/20251230_161923.png"
loading="lazy"
alt="展示示意图"
>&lt;/li>
&lt;li>都配置好后，执行编辑器菜单-&amp;gt;发行-&amp;gt;网站-PC web或手机H5,进行打包：
打包完成后，把&lt;code>h5&lt;/code>目录复制到桌面，如下图所示文件夹位置。
&lt;img src="https://changxiangyu.cn/images/uniapp/20251230163111.jpg"
loading="lazy"
alt="展示示意图"
>&lt;/li>
&lt;li>将配置文件&lt;code>config.js&lt;/code>加入到根目录，确保与&lt;code>index.html&lt;/code>同级&lt;/li>
&lt;li>&lt;img src="https://changxiangyu.cn/images/uniapp/20251230163119.jpg"
loading="lazy"
alt="展示示意图"
>
此时&lt;code>index.html&lt;/code>中的&lt;code>&amp;lt;script src=&amp;quot;./config.js&amp;gt;&lt;/code>就能正确找到配置文件，从而实现读取。
可以改变&lt;code>config.js&lt;/code>文件配置，然后刷新浏览器页面，查看是否更改。&lt;/li>
&lt;/ol></description></item><item><title>Uniapp H5端解决图片拍照旋转与压缩上传方案</title><link>https://changxiangyu.cn/p/uniapp-h5%E7%AB%AF%E8%A7%A3%E5%86%B3%E5%9B%BE%E7%89%87%E6%8B%8D%E7%85%A7%E6%97%8B%E8%BD%AC%E4%B8%8E%E5%8E%8B%E7%BC%A9%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/</link><pubDate>Mon, 09 Jan 2023 10:00:00 +0800</pubDate><guid>https://changxiangyu.cn/p/uniapp-h5%E7%AB%AF%E8%A7%A3%E5%86%B3%E5%9B%BE%E7%89%87%E6%8B%8D%E7%85%A7%E6%97%8B%E8%BD%AC%E4%B8%8E%E5%8E%8B%E7%BC%A9%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/</guid><description>&lt;p>在 Uniapp 开发 H5 应用时，涉及到手机拍照上传的功能往往会遇到两个棘手的问题：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>图片方向不对&lt;/strong>：不同厂商的手机（尤其是 iOS 和部分 Android）在拍照时，图片实际上是“横着”保存的，通过 EXIF 信息标记了方向。直接在 &lt;code>img&lt;/code> 标签显示可能正常，但一旦绘制到 Canvas 或上传到服务器，图片就会歪掉（通常是旋转了 90 度）。&lt;/li>
&lt;li>&lt;strong>图片体积过大&lt;/strong>：手机原图动辄 5MB+，直接上传消耗流量且速度慢，需要在前端进行压缩。&lt;/li>
&lt;/ol>
&lt;p>本文将分享一个基于 &lt;code>Exif.js&lt;/code> 和 &lt;code>Canvas&lt;/code> 的完整解决方案。&lt;/p>
&lt;h2 id="准备工作">准备工作&lt;/h2>
&lt;p>我们需要引入两个核心工具库：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Exif.js&lt;/strong>：用于读取图片的元数据（Metadata），核心是获取 &lt;code>Orientation&lt;/code>（方向）标识。&lt;/li>
&lt;li>&lt;strong>Mobile-detect&lt;/strong>（可选）：用于辅助判断设备类型，处理特定机型的兼容性差异。&lt;/li>
&lt;/ol>
&lt;h3 id="1-引入-exifjs">1. 引入 Exif.js&lt;/h3>
&lt;p>由于 &lt;code>exif.js&lt;/code> 是一个较老的库，建议将其源码保存到项目中，例如 &lt;code>common/js/toolJs/exif.js&lt;/code>。
&lt;em>(注：由于源码较长，此处不贴出完整库代码，请直接下载官方版本或使用 npm 安装)&lt;/em>&lt;/p>
&lt;h3 id="2-核心组件实现">2. 核心组件实现&lt;/h3>
&lt;p>我们将功能封装在一个 Vue 组件中。主要流程如下：
&lt;code>选择图片&lt;/code> -&amp;gt; &lt;code>读取EXIF方向&lt;/code> -&amp;gt; &lt;code>Canvas重绘(旋转+压缩)&lt;/code> -&amp;gt; &lt;code>获取Base64&lt;/code> -&amp;gt; &lt;code>上传&lt;/code>。&lt;/p>
&lt;h4 id="html-结构">HTML 结构&lt;/h4>
&lt;p>简单的界面，包含预览图、拍照按钮和上传按钮。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;template&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;container&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;image :src=&amp;#34;photoSrc&amp;#34; mode=&amp;#34;aspectFit&amp;#34; style=&amp;#34;width: 100%; height: 300px;&amp;#34;&amp;gt;&amp;lt;/image&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;button type=&amp;#34;primary&amp;#34; @click=&amp;#34;takePhoto&amp;#34;&amp;gt;拍照/选图&amp;lt;/button&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;button type=&amp;#34;primary&amp;#34; @click=&amp;#34;uploadPhoto&amp;#34; :disabled=&amp;#34;!photoSrc&amp;#34;&amp;gt;上传&amp;lt;/button&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/template&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="核心-js-逻辑">核心 JS 逻辑&lt;/h3>
&lt;p>首先引入必要的库：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">import EXIF from &amp;#39;../../common/js/toolJs/exif.js&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">import MobileDetect from &amp;#39;mobile-detect&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">export default {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> photoSrc: &amp;#39;&amp;#39;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> methods: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ...后续方法
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="关键步骤解析">关键步骤解析&lt;/h3>
&lt;ol>
&lt;li>获取图片并开启处理流程
使用 &lt;code>uni.chooseImage&lt;/code> 获取图片，然后调用 &lt;code>detail&lt;/code> 方法进行处理。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">takePhoto() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uni.chooseImage({
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> count: 1,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> success: async (res) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 开启异步处理流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.photoSrc = await this.detail(res.tempFilePaths[0])
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fail: (res) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.error(res)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">},
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>读取 EXIF Orientation 信息
这是修正方向的关键。我们需要封装一个 Promise 方法来读取图片的 Orientation 标签。&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>1: 正常&lt;/li>
&lt;li>6: 顺时针旋转90度&lt;/li>
&lt;li>8: 逆时针旋转90度&lt;/li>
&lt;li>3: 旋转180度&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">getImageTag(file, tag, suc) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (!file) return 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return new Promise((resolve, reject) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let imgObj = new Image()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> imgObj.src = file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uni.getImageInfo({
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> src: file,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> success(res) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EXIF.getData(imgObj, function() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> EXIF.getAllTags(this);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 获取方向标记
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let or = EXIF.getTag(this, &amp;#39;Orientation&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resolve(suc(or))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">},
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>Canvas 旋转与压缩
这是最复杂的环节。我们需要根据 &lt;code>Orientation&lt;/code> 的值，利用 &lt;code>Canvas&lt;/code> 的 &lt;code>rotate&lt;/code> 方法将图片“扳正”。同时，通过控制 &lt;code>Canvas&lt;/code> 的尺寸来实现压缩。&lt;/li>
&lt;/ol>
&lt;p>注意：代码中加入了一个 &lt;code>getPlat()&lt;/code> 判断，这是因为在实际测试中发现，部分 Android 环境下 Canvas 的旋转行为可能与 iOS 不一致，需要做特殊处理。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">// 判断是否为 Android 终端
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">getPlat() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let u = navigator.userAgent;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return u.indexOf(&amp;#39;Android&amp;#39;) &amp;gt; -1 || u.indexOf(&amp;#39;Adr&amp;#39;) &amp;gt; -1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">},
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">async detail(url) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let maxWidth = 800; // 设置最大宽度进行压缩
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let Orientation = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 1. 获取方向
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await this.getImageTag(url, &amp;#39;Orientation&amp;#39;, function(e) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (e != undefined) Orientation = e;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var img = null;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var canvas = null;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 2. 加载图片资源
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await this.comprossImage(url, maxWidth, function(e) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img = e.img;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas = e.canvas;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.log(&amp;#34;图片方向角:&amp;#34;, Orientation)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let baseStr = &amp;#39;&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 3. 根据方向角进行旋转修正
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 注意：这里针对不同平台做了一些特定逻辑处理（根据实际调试情况调整）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switch (Orientation) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 6: // 需要顺时针（向右）90度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> baseStr = this.getPlat() ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.rotateImg(img, &amp;#39;right&amp;#39;, canvas) :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.rotateImg(img, &amp;#39;&amp;#39;, canvas); // 某些安卓机型可能不需要手动旋，视具体Webview内核而定
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 8: // 需要逆时针（向左）90度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> baseStr = this.getPlat() ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.rotateImg(img, &amp;#39;left&amp;#39;, canvas) :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.rotateImg(img, &amp;#39;&amp;#39;, canvas);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 3: // 180度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> baseStr = this.rotateImg(img, &amp;#39;right&amp;#39;, canvas, 2);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> baseStr = this.rotateImg(img, &amp;#39;&amp;#39;, canvas);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return baseStr;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">},
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>旋转的具体实现 (rotateImg)
利用 &lt;code>Canvas&lt;/code> 上下文的 &lt;code>rotate&lt;/code> 和 &lt;code>drawImage&lt;/code>。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rotateImg(img, direction, canvas, times = 1) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ...初始化参数，计算宽高...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var width = img.width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var height = img.height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 压缩逻辑：限制最大宽度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let maxWidth = 800;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (width &amp;gt; maxWidth) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> height = Math.floor(height * (maxWidth / width));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> width = maxWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 旋转角度计算
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var step = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (direction == &amp;#39;right&amp;#39;) step += times;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else if (direction == &amp;#39;left&amp;#39;) step -= times;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var degree = step * 90 * Math.PI / 180;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var ctx = canvas.getContext(&amp;#39;2d&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switch (step) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 1: // 旋转90度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.rotate(degree);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.drawImage(img, 0, -height, width, height);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 2: // 旋转180度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.rotate(degree);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.drawImage(img, -width, -height, width, height);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> case 3: // 旋转270度（-90度）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.rotate(degree);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.drawImage(img, -width, 0, width, height);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default: // 不旋转
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ctx.drawImage(img, 0, 0, width, height);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 输出压缩后的 Base64，quality 设置为 0.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return canvas.toDataURL(&amp;#34;image/jpeg&amp;#34;, 0.8);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="5">
&lt;li>上传逻辑
最后，将获取到的 Base64 字符串（去除头部信息后）发送给后端。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">uploadPhoto() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (!this.photoSrc) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let obj = {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 去除 base64 头部，后端通常只需要内容
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Photo: this.photoSrc.split(&amp;#39;;base64,&amp;#39;)[1],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> TimeStamp: new Date().getTime(),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ...其他业务参数
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 发起请求
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // this.$http.baseRequest(...)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="遇到的坑与总结">遇到的坑与总结&lt;/h2>
&lt;ul>
&lt;li>Canvas 宽高混淆：当图片旋转 90 度时，Canvas 的 width 和 height 必须互换，否则图片会被裁剪或拉伸。&lt;/li>
&lt;li>Android 兼容性：代码中 this.getPlat() 的判断非常重要。部分 Android 手机的 WebView 或者浏览器在上传图片时会自动修正方向，如果我们再手动旋转一次，图片反而会歪掉。建议在真机上多测试几款主流机型。&lt;/li>
&lt;li>内存溢出：对于超大分辨率的图片（如 4000x3000），Canvas 绘制可能会导致 iOS Webview 崩溃（OOM）。解决方案是在绘制前先大幅度压缩图片尺寸（如限制 maxWidth）。&lt;/li>
&lt;/ul>
&lt;p>通过以上方案，我们不仅解决了图片“歪脖子”的问题，还实现了前端压缩，大大减轻了服务器带宽压力。&lt;/p></description></item><item><title>uniapp拍照上传图片h5</title><link>https://changxiangyu.cn/p/uniapp%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/</link><pubDate>Fri, 30 Dec 2022 13:05:18 +0800</pubDate><guid>https://changxiangyu.cn/p/uniapp%E6%8B%8D%E7%85%A7%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87h5/</guid><description>&lt;h1 id="step-1-界面代码实现">Step 1: 界面代码实现&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;template&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;body&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;btn&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;view class=&amp;#34;picture-img&amp;#34; ref=&amp;#34;uploadContent&amp;#34; id=&amp;#34;uploadContent&amp;#34; @click=&amp;#34;takePhotos()&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;div class=&amp;#34;loader-19&amp;#34; v-if=&amp;#34;loader&amp;#34;&amp;gt;&amp;lt;/div&amp;gt;点击修改
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/view&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/template&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="step-2-使用到的方法">Step 2: 使用到的方法&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;span class="lnt">96
&lt;/span>&lt;span class="lnt">97
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">takePhotos() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const _that = this;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (document.getElementById(&amp;#34;take-picture&amp;#34;) == null) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let input = _that.createInputAndSetAttribute();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$refs.uploadContent.$el.appendChild(input);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.onchange = async (event) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.loader = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var files = event.target.files
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (files &amp;amp;&amp;amp; files.length &amp;gt; 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const file = files[0];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 压缩图片需要的一些元素和对象
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var reader = new FileReader(),
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img = new Image();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 缩放图片需要的canvas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var canvas = document.createElement(&amp;#39;canvas&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var context = canvas.getContext(&amp;#39;2d&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // base64地址图片加载完毕后
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onload = function() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var originWidth = this.width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var originHeight = this.height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 最大尺寸限制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var maxWidth = 960,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maxHeight = 1280;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 目标尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var targetWidth = originWidth,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = originHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片尺寸超过400x400的限制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth &amp;gt; maxWidth || originHeight &amp;gt; maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth / originHeight &amp;gt; maxWidth / maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 更宽，按照宽度限定尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = maxWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = Math.round(maxWidth * (originHeight / originWidth));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = maxHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = Math.round(maxHeight * (originWidth / originHeight));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // canvas对图片进行缩放
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = targetWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = targetHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 清除画布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.clearRect(0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 图片压缩
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.drawImage(img, 0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // canvas转为blob并上传
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.toBlob(async (blob) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const newFile = new File([blob], &amp;#39;123.jpg&amp;#39;, {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: blob.type
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const imgPath = await upload(newFile, file.path, `/qy/photo`)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const detectionRes = await detection(imgPath)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await editFacePhoto(detectionRes).then(res =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (res.code === 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.photoSrc = res.imgUrl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$u.toast(&amp;#34;上传成功！&amp;#34;, 2000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.$u.toast(res.msg, 3000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> })
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.loader = false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> _that.removeDocument()
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }, file.type || &amp;#39;image/png&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 文件base64化，以便获知图片原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onload = function(e) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.src = e.target.result;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.readAsDataURL(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> document.querySelector(&amp;#34;#take-picture&amp;#34;).click();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// 创建input并设置input的属性
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">createInputAndSetAttribute() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> var input = document.createElement(&amp;#39;input&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.type = &amp;#39;file&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.id = &amp;#39;take-picture&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.accept = &amp;#39;image/*&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // input.capture = &amp;#39;user&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.opacity = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.position = &amp;#39;absolute&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.top = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.left = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.width = &amp;#39;50px&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> input.style.height = &amp;#39;50px&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return input;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">// 移除input节点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">removeDocument() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const uploadContent = document.getElementById(&amp;#34;uploadContent&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const takePicture = document.getElementById(&amp;#34;take-picture&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uploadContent.removeChild(takePicture);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可参考： &lt;a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file" target="_blank" rel="noopener"
>https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file&lt;/a>&lt;/p>
&lt;h2 id="目前的实现方式有几个优化点">目前的实现方式有几个优化点：&lt;/h2>
&lt;ol>
&lt;li>Vue 违规操作：在 Vue/Uniapp 中频繁使用 document.createElement、appendChild 和 removeChild 是不推荐的（这是 jQuery 时代的思维），应该利用 Vue 的模板语法。&lt;/li>
&lt;li>回调地狱：FileReader、Image.onload、canvas.toBlob 层层嵌套，代码难以维护。&lt;/li>
&lt;li>逻辑耦合：压缩逻辑、上传逻辑和 UI 交互混在一起。
以下是优化后的版本，采用 Vue 数据驱动 的方式，并将压缩逻辑封装为 Promise，使代码清晰易读。&lt;/li>
&lt;/ol>
&lt;h2 id="优化思路">优化思路&lt;/h2>
&lt;ol>
&lt;li>&lt;strong>移除 DOM 操作&lt;/strong>：将 &lt;code>&amp;lt;input type=&amp;quot;file&amp;quot;&amp;gt;&lt;/code> 直接写在 &lt;code>&amp;lt;template&amp;gt;&lt;/code> 中并通过 &lt;code>v-show&lt;/code> 隐藏，通过 &lt;code>ref&lt;/code> 触发点击，避免动态创建销毁 DOM。&lt;/li>
&lt;li>&lt;strong>异步扁平化&lt;/strong>：将图片加载和 Canvas 压缩逻辑封装成 &lt;code>Promise&lt;/code>，使用 &lt;code>async/await&lt;/code> 替代回调函数。&lt;/li>
&lt;li>&lt;strong>功能拆分&lt;/strong>：将“选择图片”、“压缩图片”、“上传业务”拆分为独立方法。&lt;/li>
&lt;/ol>
&lt;h2 id="step-1-界面代码实现-1">Step 1: 界面代码实现&lt;/h2>
&lt;p>使用 &lt;code>ref&lt;/code> 引用隐藏的 input 元素，保持页面结构整洁。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;body&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;btn&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- 触发按钮 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">view&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;picture-img&amp;#34;&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="na">click&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;triggerSelect&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;loader-19&amp;#34;&lt;/span> &lt;span class="na">v-if&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;loader&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {{ loader ? &amp;#39;处理中...&amp;#39; : &amp;#39;点击修改&amp;#39; }}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- 隐藏的原生Input，用于H5调用相机/文件 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- accept=&amp;#34;image/*&amp;#34; 限制图片，capture=&amp;#34;user&amp;#34; 可选：强制调用前置摄像头 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">input&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">ref&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;fileInput&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">accept&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;image/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;hidden-input&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">@&lt;/span>&lt;span class="na">change&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;handleFileChange&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">view&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">style&lt;/span> &lt;span class="na">scoped&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="nc">hidden-input&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">display&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">none&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c">/* 隐藏input */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">/* 你的其他样式... */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">style&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="step-2-逻辑实现-script">Step 2: 逻辑实现 (Script)&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">export default {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> loader: false,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> photoSrc: &amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> methods: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 1. 触发文件选择
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> triggerSelect() {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 在Uniapp H5中，通过$refs获取原生DOM元素并点击
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 注意：App端不支持此操作，App端请使用 uni.chooseImage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$refs.fileInput.click();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 2. 监听文件改变
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> async handleFileChange(event) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const files = event.target.files;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (!files || files.length === 0) return;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.loader = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const file = files[0];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> try {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // A. 压缩图片
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const { blob, filename } = await this.compressImage(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // B. 构造新的File对象 (解决部分浏览器兼容性)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const newFile = new File([blob], filename || &amp;#39;compressed.jpg&amp;#39;, { type: blob.type });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // C. 执行上传业务
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> await this.uploadProcess(newFile, file.path); // file.path 在H5 input中可能不存在，视业务需求调整
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } catch (error) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> console.error(&amp;#34;处理失败&amp;#34;, error);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(&amp;#34;图片处理失败&amp;#34;, 2000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } finally {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.loader = false;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 清空value，确保下次选择同一张图也能触发change事件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> event.target.value = &amp;#39;&amp;#39;;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 3. 核心：图片压缩工具函数 (返回Promise)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> compressImage(file) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return new Promise((resolve, reject) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const reader = new FileReader();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.readAsDataURL(file);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onload = (e) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const img = new Image();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.src = e.target.result;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onload = () =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 原始尺寸
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const originWidth = img.width;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const originHeight = img.height;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 目标尺寸配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const maxWidth = 960;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const maxHeight = 1280;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let targetWidth = originWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> let targetHeight = originHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 计算缩放比例
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth &amp;gt; maxWidth || originHeight &amp;gt; maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (originWidth / originHeight &amp;gt; maxWidth / maxHeight) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = maxWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = Math.round(maxWidth * (originHeight / originWidth));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetHeight = maxHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetWidth = Math.round(maxHeight * (originWidth / originHeight));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // Canvas 绘制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const canvas = document.createElement(&amp;#39;canvas&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const context = canvas.getContext(&amp;#39;2d&amp;#39;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.width = targetWidth;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.height = targetHeight;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.clearRect(0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> context.drawImage(img, 0, 0, targetWidth, targetHeight);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 导出 Blob
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> canvas.toBlob((blob) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (blob) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resolve({ blob, filename: file.name });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reject(new Error(&amp;#39;Canvas to Blob failed&amp;#39;));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }, file.type || &amp;#39;image/jpeg&amp;#39;, 0.8); // 0.8 为压缩质量
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> img.onerror = (err) =&amp;gt; reject(err);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> };
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reader.onerror = (err) =&amp;gt; reject(err);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> });
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 4. 上传业务逻辑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> async uploadProcess(file, originalPath) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // 假设 upload, detection, editFacePhoto 已导入或定义
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const imgPath = await upload(file, originalPath, `/qy/photo`);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const detectionRes = await detection(imgPath);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> const res = await editFacePhoto(detectionRes);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (res.code === 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.photoSrc = res.imgUrl;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(&amp;#34;上传成功！&amp;#34;, 2000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } else {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this.$u.toast(res.msg, 3000);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="关键改进点说明">关键改进点说明&lt;/h3>
&lt;ol>
&lt;li>Input 复用：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>原代码每次点击都 &lt;code>createElement&lt;/code>，不仅性能低，而且在部分安卓 WebView 中可能因为 DOM 未完全插入而无法唤起相机。&lt;/li>
&lt;li>新代码将&lt;code> &amp;lt;input&amp;gt;&lt;/code> 静态化，利用 &lt;code>event.target.value = ''&lt;/code> 重置状态，确保稳定性。&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>Promise 封装：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>原代码在 &lt;code>img.onload&lt;/code> 内部嵌套了大量业务逻辑。&lt;/li>
&lt;li>新代码将压缩逻辑提取为 &lt;code>compressImage&lt;/code>，返回 Promise，使得主流程 &lt;code>handleFileChange&lt;/code> 可以使用 &lt;code>await&lt;/code> 顺序执行，逻辑一目了然。&lt;/li>
&lt;/ul>
&lt;ol start="3">
&lt;li>兼容性处理：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>增加了 &lt;code>canvas.toBlob&lt;/code> 的质量参数（0.8），可进一步减小体积。&lt;/li>
&lt;li>增加了 &lt;code>input&lt;/code> 的 &lt;code>display: none&lt;/code> 样式，避免页面出现奇怪的占位。&lt;/li>
&lt;/ul></description></item></channel></rss>